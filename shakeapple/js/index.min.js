$(function(){function z(){var a={action:"queryInfo",openid:openid,active:active},b=function(a){0==a.errcode&&(u=!0,d.html(w=a.name),e.html(x=a.tel))};ns.ajax(a,b,!1)}function A(){var a={action:"queryGiftList",active:active},b=function(a){0==a.errcode?v=a.list:A()};ns.ajax(a,b,!1)}function B(){ns.loadHide(),b.show(),z(),A()}function C(){function d(b){if(b&&c.removeClass("show appleShake fall"),!(a.length>0))return c.addClass("ining"),!1;var e=Math.floor(Math.random()*a.length);c.eq(a[e]).addClass("show"),a.splice(e,1),setTimeout(function(){d()},150)}var b,a=[];for(b=0;s>b;b++)a[b]=b;d()}function D(){function e(){return d>c?!1:(d==c&&g.show(),b.eq(d).addClass("show"),d++,setTimeout(e,100),void 0)}var b=($(".linebox"),$(".line")),c=b.length,d=0;e()}function E(){var a=c.not(".fall"),b=a.length,d=Math.floor(Math.random()*b);a.removeClass("appleShake").eq(d).addClass("appleShake")}function G(){ns.log({conType:"input",confirm:function(){var a,b,c,f,g;return ns.ajaxLock?!1:(a=$("#ns_dialog_name").val(),b=$("#ns_dialog_tel").val(),ns.check.name(a)?ns.check.tel(b)?(ns.load(),ns.ajaxLock=!0,c={action:"reg",name:a,active:active,tel:b,openid:openid},f=this,g=function(c){ns.loadHide(),ns.ajaxLock=!1,ns.tip(c.errmsg),c&&0==c.errcode&&(u=!0,d.html(w=a),e.html(x=b),f.hide())},ns.ajax(c,g),void 0):!1:!1)}})}function H(){u?I():G()}function I(){if(ns.ajaxLock)return!1;ns.load(),ns.ajaxLock=!0;var a={action:"addDetail",name:w,active:active,tel:x,openid:openid},b=function(a){var b,c,d;ns.loadHide(),setTimeout(function(){ns.ajaxLock=!1},2500),console.log(a),0==a.errcode?($(".fall").remove(),b="",ns.tip("获取成功！"),0==a.gift||null==a.gift?b="很遗憾<br>您没有中奖！":(b="恭喜您获得<br>"+v[a.gift]["name"],t=!0),p.html(b),c=$(".apple"),d=Math.floor(Math.random()*c.length),c.eq(d).addClass("appleShake"),setTimeout(function(){c.eq(d).addClass("fall").append(y),setTimeout(function(){D()},700)},1500)):ns.tip(a.errmsg)};ns.ajax(a,b)}function J(){if(ns.ajaxLock)return!1;ns.load(),ns.ajaxLock=!0;var a={action:"queryDetailList",active:active,openid:openid},b=function(a){var b,c,d,e,f,g;if(ns.loadHide(),ns.ajaxLock=!1,a&&0==a.errcode){if(t=!1,b=a.list,c=b.length,d="",e="",f=0,c>0){for(g=0;c>g;g++)0!=b[g].gift&&(f=1,e="1"==b[g].exchange?'<span class="gift_btn">已兑换</span>':'<span class="gift_btn gift_btn_show"><img src="img/a3.png"></span>',d+='<li data-id="'+b[g].oid+'">'+'<span class="gift_name to_e">'+v[b[g].gift]["name"]+"</span>"+e+"</li>");0==f&&(d+='<li class="t_c">您还没有中奖呢！继续努力吧！</li>')}else d+='<li class="t_c">您还没有中奖呢！继续努力吧！</li>';j.show().find("ul").html(d)}};ns.ajax(a,b)}function K(a){var d,e,b=$(this),c=n.val();return ns.check.empty(c,"请输入兑换密码！")?!1:ns.ajaxLock?!1:(ns.load(),ns.ajaxLock=!0,d={action:"giftExchange",oid:a,active:active,pwd:c},e=function(a){ns.loadHide(),ns.ajaxLock=!1,ns.tip(a.errmsg),0==a.errcode&&(k.hide(),b.append('<span class="gift_btn">已兑换</span>').find(".gift_btn_show").remove())},ns.ajax(d,e),void 0)}ns.load(),ns.loadImgs({sources:{bg:"bg.jpg",title:"title.png",tree:"tree.png",apple1:"apple1.png",apple2:"apple2.png",btn1:"btn1.png",btn2:"btn2.png",btn3:"btn3.png"},dir:"img/",progress:function(){ns.load(this.percent)},end:B});var b=$("#main"),c=$(".apple"),d=$("#myName"),e=$("#myTel"),f=$(".treebox"),g=$(".giftbox"),i=($("#share"),$("#mygift")),j=$(".mygift"),k=$(".exchange"),l=$(".close"),n=($(".exchange .gift_name"),$("#pwd")),o=$("#pwd_go"),p=$("#gift"),q=$(".btn_goMyGift"),r=$(".btn_close"),s=c.length,t=!0,u=!1,v=[],w="",x="",y='<div class="linebox"><div class="line line1"></div><div class="line line2"></div><div class="line line3"></div><div class="line line4"></div><div class="line line5"></div></div>';C(!0),window.setInterval(E,2500),f.on(click,H),ns.shake(H),r.on(click,function(){g.hide()}),q.on(click,function(){g.hide(),i.trigger(click)}),i.on(click,function(){u?t?J():j.show():G()}),j.on(click,".gift_btn_show",function(){var b=($(this),$(this).parents("li"));id=b.data("id"),name=b.find(".gift_name").html(),k.show().find(".gift_name").html(name),o.on(click,function(){K.call(b,id)})}),l.on(click,function(){var a=$(this).parents(".box_cl");a.hide(),a.hasClass("mygift")&&(getAppleTimes=0)}),ns.addShare("#share")});