(function(){var t=[],s=function(W,Y){var V=0;var H=0;for(var X in W){H++}for(var X in W){if(/.mp3/.test(W[X])){V;t[X]=new Audio(W[X]);t[X].load();if(++V>=H){Y()}continue}t[X]=new Image();t[X].onload=function(){G.html((V/H*100).toFixed(2)+"%");if(++V>=H){Y()}};t[X].src=W[X]}};var e=document.getElementById("canvas"),d=$(window).width()>640?640:$(window).width(),j=$(window).height(),B=createjs,h=new B.Stage(e),x=navigator.userAgent.match(/iP(ad|hone|od)/i),c=1,A=50,u=0,g=false,G=$("#xl_loading_p"),a=$("#xl_loading"),i=$("#main"),m=$("#btn_go"),f=$(".page"),q=$(".page1"),o=$(".page2"),n=$(".page3"),l=$(".page4"),K=$("#distance"),U=$("#time"),r=$("#btn_action"),Q=$(".phone"),D=$(".btn_rank"),v=$("#btn_restart"),J=$("#rank"),k=J.find("ul"),I=$("#myRank"),p=$("#myScore");window.onload=function(){var H={road:"img/road.png",roadLr:"img/roadLr.png",man:"img/man.png",coin:"img/coin.png",buildingBg:"img/buildingBg.png",buildingOn:"img/buildingOn.png",car:"img/car.png"};s(H,C)};B.Touch.enable(h);function C(){G.html("100%");i.show();a.removeClass("xl_loding_show");load_h();G.html("Loading...");N()}function N(){h.clear();main=new B.Container();h.addChild(main);TIME=0;timeGo=null;fallSpeed=3000;COINS=[];Man_now=0;SCORE=0;TIME=0;lastDeviceGet=0;ACTION=false}function R(){O();clearInterval(timeGo);B.Ticker.setFPS(60);B.Ticker.addEventListener("tick",F);timeGo=setInterval(function(){TIME++},1000)}function O(){d=t.roadLr.width*j/t.roadLr.height;e.width=d;e.height=j;roadLr=new B.Shape();roadLr.graphics.bf(t.roadLr,"repeat-y",new B.Matrix2D(d/t.road.width,0,0,j/t.road.height,0,0)).dr(0,-j,d,j*2);road=new B.Bitmap(t.road);road.setTransform(0,0,d/t.road.width,j/t.road.height);man_set={bw:100,bh:148,regX:0,regY:0,w:d*0.15,x:d*0.5,y:j*0.87,count:10,speed:0.07};man_set.h=man_set.bh*man_set.w/man_set.bw;man_set.hw=man_set.w*0.5;man_set.hh=man_set.h*0.5;man_set.bottom=man_set.y+man_set.hh;man_set.top=man_set.y-man_set.hh;coin_set={bw:160,bh:160,regX:0,regY:0,w:d*0.18,h:d*0.18,countC:5,probability:0.3};coin_set.hw=coin_set.w*0.5;coin_set.hh=coin_set.h*0.5;coin_set.rowH=coin_set.h*2.5;coin_set.col=parseInt(j/coin_set.rowH)+1;S_LEFT=d*0.15;S_RIGHT=d*0.85;man_anim=new B.SpriteSheet({images:[t.man],frames:{width:man_set.bw,height:man_set.bh,count:man_set.count,regX:man_set.regX,regY:man_set.regY},animations:{man0:[0,1,"man0",man_set.speed],man1:[2,3,"man1",man_set.speed],man2:[4,5,"man2",man_set.speed],man3:[6,7,"man3",man_set.speed],man4:[8,9,"man4",man_set.speed]}});man=new B.Sprite(man_anim,"man"+Man_now);man.setTransform(man_set.x,man_set.y,man_set.w/man_set.bw,man_set.h/man_set.bh,0,0,0,man_set.bw*0.5,man_set.bh*0.5).framerate=30;man.maxL=S_LEFT+man_set.hw;man.maxR=S_RIGHT-man_set.hw;man.trs=d*0.35/90;coinsContainer={coins1:new B.Container(),coins2:new B.Container()};scoreBg=new B.Shape();scoreBg.graphics.f("#24981d").s("#fff").rr(d*0.17,10,d*0.66,j*0.1,7);scoreShow=new B.Text("0 m","1rem georgiab","#fff");scoreShow.x=d*0.5;scoreShow.y=10+j*0.05;scoreShow.textAlign="center";scoreShow.textBaseline="middle";main.addChild(roadLr,road,coinsContainer.coins1,coinsContainer.coins2,scoreBg,scoreShow,man);if(window.DeviceMotionEvent){window.addEventListener("devicemotion",L,false)}else{alert("亲，你的浏览器不支持重力感应哟~")}}function P(Y,ab){var W=0;if(SCORE>5000){fallSpeed=1000}else if(SCORE>3000){fallSpeed=1500}else{if(SCORE>2000){Man_now=4;fallSpeed=2000}else{if(SCORE>1500){Man_now=3;fallSpeed=2250}else{if(SCORE>1000){Man_now=2;fallSpeed=2500}else{if(SCORE>500){Man_now=1;fallSpeed=2750}}}}}man.gotoAndPlay("man"+Man_now);if(Y=="coins2"||ab){W=-j}coinsContainer[Y].removeAllChildren();coinsContainer[Y].y=W;if(ab){var H=coin_set.col}else{var H=0}for(var Z=0;Z<H;Z++){var V=b(Man_now);var ac=d*(Math.random());var aa=coin_set.rowH*Z;if(ac<S_LEFT){ac=S_LEFT}else{if(ac>S_RIGHT-coin_set.w){ac=S_RIGHT-coin_set.w}}var X=Z;V.x=ac;V.y=aa;if(Y=="coins2"){X=coin_set.col+Z}COINS[X]=V;coinsContainer[Y].addChild(COINS[X])}if(ab){B.Tween.get(coinsContainer[Y]).to({y:j},fallSpeed*2).call(function(){P(Y,true)})}else{B.Tween.get(coinsContainer[Y]).to({y:j},fallSpeed).call(function(){P(Y,true)})}}function b(X){var H=Math.floor(Math.random()*coin_set.countC);var W=new B.SpriteSheet({images:[t.coin],frames:[[coin_set.bw*H,coin_set.bh*X,coin_set.bw,coin_set.bh]],animations:{go:{frames:[0],next:null}}});var V=new B.Sprite(W,"go");V.setTransform(0,0,coin_set.w/coin_set.bw,coin_set.h/coin_set.bh).framerate=30;return V}function F(){h.update();if(ACTION){scoreShow.text=++SCORE+" m"}for(var V=0,W=COINS.length;V<W;V++){if(!COINS[V]||COINS[V].geted){continue}var H=COINS[V].y+COINS[V].parent.y;if(!COINS[V].geted&&H-man_set.bottom>0){y();return}if(collCheck.rect(COINS[V],man)){COINS[V].geted=true;B.Tween.get(COINS[V]).to({x:d*0.5,y:-COINS[V].parent.y,alpha:0},500,B.Ease.backIn)}}}function L(X){var Y=new Date().getTime();if(Y-lastDeviceGet>70){lastDeviceGet=Y;var W=X.accelerationIncludingGravity;var V=Math.round(((W.x)/9.81)*-90);if(x){V=V*-1}var H=man_set.x+(V*man.trs);B.Tween.get(man).to({x:H},150,B.Ease.linear)}}function y(){if(SCORE>myBestScore){w();numberTo(U,SCORE,37)}else{U.html(myBestScore)}B.Ticker.removeAllEventListeners();clearInterval(timeGo);f.removeClass("current");n.addClass("current");window.share.title="我的Baby用"+TIME+"秒爬了"+SCORE+"米！不服？来战！";numberTo(K,SCORE,37)}function M(){$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"queryInfo",active:active,openid:openid},dataType:check.ajaxDataType,success:function(H){console.log(H);if(H.errcode==0){I.html(H.rank);p.html(H.score)}else{alert(H.errmsg)}},error:function(){$tip(check.ajaxError)}})}function w(){if(!enKey||!enIv){return}load();$.ajax({url:check.ajaxUrl+"?rand="+Math.random(),type:check.ajaxType,dataType:check.ajaxDataType,data:{action:"addDetail",active:active,openid:openid,score:SnowCryEncrypt(SCORE,enKey,enIv),time:SnowCryEncrypt(TIME,enKey,enIv)},success:function(H){console.log(H);if(H.errcode==0){M();$tip("更新成功！")}load_h()},error:function(){$tip(check.ajaxError);ajaxLock=0}})}function T(){load();$.ajax({url:"conn/ajax.php?xl_r="+Math.random(),type:"POST",dataType:"json",data:{action:"queryList",pageIndex:c,pageSize:A,active:active},success:function(Y){load_h();console.log(Y);if(Y.errcode==0){ajaxLock=false;var X=Y.list,W=X.length,V="";if(W>0){c++;for(var H=0;H<W;H++){u++;V+='<li><span class="rank_num">'+u+'</span><span class="rank_name">'+X[H].name+'</span><span class="rank_score">'+(X[H].score||0)+"</span></li>"}k.append(V)}else{g=true}}}})}function z(){load();$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"checkTimes",active:active,openid:openid},dataType:check.ajaxDataType,success:function(H){console.log(H);if(H.errcode==0){f.removeClass("current");o.addClass("current");R();man.y=j*0.3}else{alert(H.errmsg)}load_h()},error:function(){load_h();$tip(check.ajaxError)}})}m.on(click,function(){if(reged==1){z();return}$log({title:"让你的朋友知道你吧！",con:'<div class="tip">请输入您的真实姓名和手机号！</div><label class="in_ic40"><span class="l"><i class="fa fa-user"></i></span><span class="r"><input type="text" placeholder="请输入姓名" id="name" name="name" maxlength="12"/></span></label><label class="in_ic40"><span class="l"><i class="fa fa-mobile"></i></span><span class="r"><input type="tel" placeholder="请输入手机号码" id="tel" name="tel" maxlength="11"/></span></label>',go:function(){var V=$("#name").val(),H=$("#tel").val();if(!check.name(V)){return false}if(!check.tel(H)){return false}load();$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"reg",name:V,active:active,tel:H,openid:openid},dataType:check.ajaxDataType,success:function(W){if(W.errcode==0){myName=V;myTel=H;reged=1;$tip("注册成功！");location.href="index.php"}else{$tip(W.errmsg)}load_h()},error:function(){load_h();$tip(check.ajaxError)}})}})});r.on(click,function(){Q.hide();man.y=man_set.y;B.Tween.get(roadLr).to({y:0}).to({y:j},fallSpeed).loop=true;SCORE=0;ACTION=true;P("coins1");P("coins2",true)});D.on(click,function(){f.removeClass("current");l.addClass("current");k.empty();c=1;g=false;u=0;T()});v.on(click,function(){if(SCORE>0||TIME>0){location.href="index.php"}else{f.removeClass("current");q.addClass("current")}});J.scroll(function(H){if(!g&&!ajaxLock&&(k.height()-J.height()-J.scrollTop()<20)){ajaxLock=true;T()}});var S=document.getElementById("bgmp3"),E=false;$(document).on("touchstart",function(){if(!E){if(S.paused!==false){S.load();E=true;S.play()}}else{S.play()}$(document).unbind("touchstart")})}());
