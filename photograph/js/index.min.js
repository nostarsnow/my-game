$(function(){function t(t){T.html((100*k.progress).toFixed(2)+"%").width((100*k.progress).toFixed(2)+"%")}function o(){T.parent().hide(),$(".btn_action").show()}function e(){TIME=0,timeGo=null,SCORE=0,scoreHad=!1,laveTimeGo=null,laveTime=4,C.hide(),I.hide(),_.show(),S.html(0)}function n(){if(f.show(),--laveTime<0)return f.hide(),i(),void clearInterval(laveTimeGo);f.html('<img src="img/num'+laveTime+'.png"/>')}function i(){d.width=r,d.height=l,c.Touch.enable(w),c.Ticker.setFPS(60),c.Ticker.addEventListener("tick",w),main=new c.Container,w.addChild(main),p()}function g(){e(),main.removeAllChildren(),clearInterval(laveTimeGo),laveTimeGo=setInterval(n,1e3),n()}function p(){hn=Math.random(),hImg=1,hn<.2&&(hImg=2),photo={w:.6*r,h:.6*r,x:.2*r,y:.3*l,r:12},line={w:.1*r,h:.1*r},h={w:.2*r,h:"",x:.5*r,y:.05*-l},hbg={w:.4*r,x:.5*r,y:.05*-l},h.h=k.getResult("h"+hImg).height*h.w/k.getResult("h"+hImg).width,hbg.h=k.getResult("t4").height*hbg.w/k.getResult("t4").width,hbg.y+=.5*h.h,photoS=new c.Shape,photoS.graphics.s("#fcd901").ss(5).rr(photo.x,photo.y,photo.w,photo.h,photo.r),photobg=new c.Shape,photobg.graphics.f("#fff").rr(photo.x-5,photo.y-5,photo.w+5,photo.h+5,photo.r),photobg.alpha=0,photoShow=new c.Container,photo_1=new c.Shape,photo_1.graphics.s("#fff").ss(10).rr(0,0,photo.w,photo.h,photo.r),photo_1bg=new c.Bitmap(k.getResult("bg1")),photo_1bg.sourceRect={x:photo.x*k.getResult("bg1").width/r,y:photo.y*k.getResult("bg1").height/l,width:photo.w*k.getResult("bg1").width/r,height:photo.h*k.getResult("bg1").height/l},photo_1bg.setTransform(0,0,r/k.getResult("bg1").width,l/k.getResult("bg1").height),photoShow.setTransform(2*photo.x+photo.w/2,2*photo.y+photo.h/2,1,1,0,0,0,photo.x+photo.w/2,photo.y+photo.h/2),lineS=new c.Shape,lineS.graphics.s("#fcd901").ss(5).mt(photo.x+.5*photo.w-.5*line.w,photo.y+.5*photo.h).lt(photo.x+.5*photo.w+.5*line.w,photo.y+.5*photo.h).mt(photo.x+.5*photo.w,photo.y+.5*photo.h-line.h/2).lt(photo.x+.5*photo.w,photo.y+.5*photo.h+line.h/2),hS=new c.Shape,hS.graphics.bf(k.getResult("h"+hImg)).dr(0,0,k.getResult("h"+hImg).width,k.getResult("h"+hImg).height),hS.setTransform(h.x,h.y,h.w/k.getResult("h"+hImg).width,h.h/k.getResult("h"+hImg).height,0,0,0,k.getResult("h"+hImg).width/2,k.getResult("h"+hImg).height/2),hbgS=new c.Shape,hbgS.graphics.bf(k.getResult("t4")).dr(0,0,k.getResult("t4").width,k.getResult("t4").height),hbgS.setTransform(hbg.x,hbg.y,hbg.w/k.getResult("t4").width,hbg.h/k.getResult("t4").height,0,0,0,k.getResult("t4").width/2,k.getResult("t4").height/2),photoShow.addChild(photo_1bg,photo_1),photoShow.alpha=0,main.addChild(photoS,lineS,hS,photoShow,photobg,hbgS),c.Tween.get(hS).wait(300).to({y:l+h.h},1700-200*(2*hn+hImg),c.Ease.circIn).call(a)}function a(){c.Tween.removeTweens(hS),c.Sound.play("btn",{loop:0});var t=hS.clone(!0);if(t.x=hS.x-photo.x,t.y=hS.y-photo.y,t.mask=photo_1,photoShow.addChild(t),main.removeChild(photoS,lineS,hS,photobg,hbgS),scoreHad)return!1;scoreHad=!0;var o=hS.y,h=photo.y,e=photo.y+photo.h,n=photo.y+.35*photo.h;o<h||o>e?SCORE=0:o<=n?SCORE=(o-h)/(n-h)-.003732:o>n&&(SCORE=(e-o)/(e-n)-.003732),SCORE<0&&(SCORE=0),SCORE=Math.abs(100*SCORE*hImg).toFixed(2),E.html("我拍到了戴王冠的公主，得了"+SCORE+"分！还有奖品拿喔！"),c.Tween.get(photobg).to({alpha:.5},300).to({alpha:0},200),c.Tween.get(photoShow).wait(100).to({alpha:1}).to({rotation:15},300).call(function(){s()}).to({scaleX:.5,scaleY:.5,x:.5*photo.w,y:1.2*photo.y},300).call(function(){for(var t=0,o=showInfo.length;t<o&&!(SCORE<=showInfo[t].score);t++);})}function s(){S.html(SCORE),_.hide(),C.show(),I.show()}var r=$(window).width()>640?640:$(window).width(),l=$(window).height(),d=document.getElementById("canvas"),c=createjs,w=new c.Stage(d),u=($("#xl_loading_p"),$("#xl_loading"),$("#main"),$("#rule")),m=$(".page"),b=($(".page0"),$(".page1"),$(".page2")),S=$("#score"),f=$("#lavetime"),R=$("#btn_action"),y=$("#btn_go"),v=$("#btn_restart"),x=$("#btn_share"),_=$(".btn_goBox"),I=($(".btn_showBox"),$(".showBg")),C=$("#show"),T=$(".progress span"),E=$("title"),O=[{id:"bg",src:"bg.jpg?3"},{id:"t1",src:"t1.png?3"},{id:"bg1",src:"bg1.jpg?3"},{id:"t3",src:"t3.png?3"},{id:"t4",src:"t4.png"},{id:"t5",src:"t5.png"},{id:"num0",src:"num0.png"},{id:"num1",src:"num1.png"},{id:"num2",src:"num2.png"},{id:"num3",src:"num3.png"},{id:"h1",src:"h1.png?3"},{id:"h2",src:"h2.png?3"},{id:"btn_action",src:"btn_action.png?1"},{id:"btn_go",src:"btn_go.png?1"},{id:"btn_restart",src:"btn_restart.png?1"},{id:"btn_share",src:"btn_share.png?1"},{id:"btn",src:"btn.mp3"}],k=new createjs.LoadQueue(!1,"./img/");if(k.installPlugin(c.Sound),k.loadManifest(O),k.on("fileload",t),k.on("complete",o),preloadLength=O.length,preloadCurrent=0,function(){var t=navigator.userAgent.toLowerCase();return!(!/iphone/i.test(t)&&!/ipad/i.test(t))}()){var G=document.getElementById("bgmp3"),B=!1;$(document).on(click,function(){B?G.play():!1!==G.paused&&(G.load(),B=!0,G.play()),$(document).unbind("touchstart")})}R.on(click,function(){m.removeClass("current"),b.addClass("current"),e()}),u.on(click,function(){e(),u.hide(),clearInterval(laveTimeGo),laveTimeGo=setInterval(n,1e3),n()}),y.on("tap",a),v.on(click,g),ns.addShare(x)});