function gameOver(a){return gamed=!0,clearInterval(timeGo),a?(setTimeout(function(){numberTo($score,TIME.toFixed(2),.7,20),$info.html("胜败乃兵家常事，大侠请重新来过！"),$page.removeClass("current"),$page3.addClass("current")},1e3),cj.Sound.play("die",{loop:0}),window.share.title="我在银基王朝用了"+TIME.toFixed(2)+"秒也没有帮小骨找到师傅！你来试试吧！还有奖品拿喔！",!1):(cj.Sound.play("suc",{loop:0}),window.share.title="我在银基王朝帮小骨找到了师傅，只用了"+TIME.toFixed(2)+"秒！你也来试试吧！还有奖品拿喔！",numberTo($score,TIME.toFixed(2),.7,20),$page.removeClass("current"),$page3.addClass("current"),uploadScore(),void 0)}function loadProgress(){$progress.html((100*preload.progress).toFixed(2)+"%").width((100*preload.progress).toFixed(2)+"%")}function loaded(){$progress.parent().hide(),$(".btn_action").show()}function timeGoing(){TIME+=.05,$time.html(TIME.toFixed(2))}function create(a,b,c){var e,d=new cj.Shape;return void 0!==c?(e="right"==c?preload.getResult("h1"):"right_c"==c?preload.getResult("h2"):preload.getResult("err"),d.graphics.s(border_color).bf(e).r(0,0,e.width,e.height),d.setTransform(a,b,col_w_2/e.width,col_h_2/e.height)):d.graphics.s(border_color).f("rgba(255,255,255,.01)").r(a,b,col_w_2,col_h_2),d}function createRow(a){var b,c,e,f,d;for(a=a||1,b=total;total+a>b;b++)for(c=Math.floor(Math.random()*col),d=0;col>d;d++)c==d&&0!=b?(f=!0,e=create(d*col_w,H-(b+1)*col_h,"right")):(f=!1,e=create(d*col_w,H-(b+1)*col_h)),main.addChild(e),function(a,b,c){e.on("click",function(){if(1==current&&(timeGo=setInterval(timeGoing,50)),a!=current||gamed)return!1;if(Math.random()<randomRedBag&&getRedBag(),c)cj.Sound.play("step",{loop:0}),current++,this.graphics=null,main.addChild(create(b*col_w,H-(a+1)*col_h,"right_c")),current>screenCount&&main.removeChildAt(0,1,2,3,4),current==total&&gameOver(),step_max>=total&&createRow(1),step_max-1>current&&(main.y+=col_h);else{this.graphics=null;var e=create(b*col_w,H-(a+1)*col_h,"err");main.addChild(e),cj.Tween.get(e).to({alpha:.5},400,cj.Ease.linear).to({alpha:.8},400,cj.Ease.linear).to({alpha:.5},400,cj.Ease.linear).loop=!0,gameOver(!0)}})}(b,d,f);total+=a}function init(){canvas.width=W,canvas.height=H,stage=new cj.Stage(canvas),main=new cj.Container,cj.Ticker.setFPS(60),cj.Touch.enable(stage),cj.Ticker.addEventListener("tick",stage),stage.addChild(main),createRow(screenCount+10)}function checkReg(){0==reged?$log({type:"reg",go:function(){var a=$("#name").val(),b=$("#tel").val();return check.name(a)?check.tel(b)?ajaxLock?!1:(ajaxLock=!0,load(),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"reg",name:a,wxid:active,tel:b,openid:openid},dataType:check.ajaxDataType,success:function(c){console.log(c),0==c.errorcode?(myName=a,myTel=b,reged=1,$tip("注册成功！"),setTimeout(function(){location.href="index.php"},500)):$tip(c.errormsg),load_h(),ajaxLock=!1},error:function(){load_h(),ajaxLock=!1,$tip(check.ajaxError)}}),void 0):!1:!1}}):checkGame()}function checkGame(){return ajaxLock?!1:(ajaxLock=!0,load(),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"text",wxid:active,activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",openid:openid},dataType:check.ajaxDataType,success:function(a){console.log(a),ajaxLock=!1,load_h(),0==a.errorcode?(load(),$page.removeClass("current"),$page2.addClass("current"),setTimeout(function(){load_h(),init()},500)):$tip(a.errormsg)},error:function(){load_h(),ajaxLock=!1,$tip(check.ajaxError)}}),void 0)}function uploadScore(){load(),console.log(TIME.toFixed(2),SnowCryEncrypt(TIME.toFixed(2),enKey,enIv)),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"recordscore",name:myName,wxid:active,activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",score:SnowCryEncrypt(TIME.toFixed(2),enKey,enIv),openid:openid},dataType:check.ajaxDataType,success:function(a){console.log(a),$tip("上传成绩成功！"),load_h()},error:function(){load_h(),$tip(check.ajaxError)}})}function getMyGift(){return ajaxLock?!1:(ajaxLock=!0,load(),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"getaward",wxid:active,activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",openid:openid},dataType:check.ajaxDataType,success:function(a){var b,c,d,e;if(console.log(a),0==a.errorcode&&a.errormsg.length>0)for(b=0,c=a.errormsg.length,d="",e="";c>b;b++)e="未兑奖"==a.errormsg[b].awardstate?'<a class="exchange" data-id="'+a.errormsg[b].awardid+'">领取</a>':'<a class="t_gray">'+a.errormsg[b].awardstate+"</a>",d+='<tr><td class="t_green">'+a.errormsg[b].awardname+" - "+a.errormsg[b].score+"元</td>"+"<td>"+e+"</td>"+"</tr>";else d='<tr><td colspan="2">还没获得奖品呢！继续努力吧！</td></tr>';$(".gift .q_table tbody").html(d),load_h(),ajaxLock=!1},error:function(){load_h(),ajaxLock=!1,$tip(check.ajaxError)}}),void 0)}function getRedBag(){return ajaxLock?!1:(ajaxLock=!0,load(),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl_r="+Math.random().toFixed(3),data:{action:"shake",wxid:active,activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",openid:openid},dataType:check.ajaxDataType,success:function(a){console.log(a),0==a.errorcode&&$tip("恭喜你！幸运的获得"+a.cash+"元现金红包"),load_h(),ajaxLock=!1},error:function(){load_h(),ajaxLock=!1,$tip(check.ajaxError)}}),void 0)}function getRank(){return ajaxLock?!1:(ajaxLock=!0,load(),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"getscorelist",wxid:active,activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",openid:openid},dataType:check.ajaxDataType,success:function(a){var b,c,d,e;if(console.log(a.errormsg),0==a.errorcode){if(a.errormsg.length>0)for(b=0,c=a.errormsg.length,d="";c>b;b++)e="",bopenid==a.errormsg[b].openid&&(e=" isme"),d+='<tr class=" '+e+' ">'+'<td class="t_geo">'+(b+1)+"</td>"+"<td>"+a.errormsg[b].name+"</td>"+"<td>"+a.errormsg[b].score+"</td>"+"</tr>"}else d='<tr><td colspan="3">暂无排行数据！</td></tr>';$(".rank .q_table tbody").html(d),ajaxLock=!1,load_h()},error:function(){ajaxLock=!1,load_h(),$tip(check.ajaxError)}}),void 0)}var col,col_w,col_h,col_w_2,col_h_2,step_max,border_color,current,total,TOTALSTEP,TIME,screenCount,W=$(window).width()>640?640:$(window).width(),H=$(window).height(),canvas=$("#canvas")[0],cj=createjs,$main=$("#main"),$game=$("#game"),$page=$(".page"),$page0=$(".page0"),$page1=$(".page1"),$page2=$(".page2"),$page3=$(".page3"),$page4=$(".page4"),$page5=$(".page5"),$score=$("#score"),$info=$("#info"),$time=$("#time"),$btn_action=$("#btn_action"),$btn_restart=$(".btn_restart"),$btn_share=$("#btn_share"),$btn_gift=$(".btn_gift"),$btn_rank=$(".btn_rank"),$progress=$(".progress span"),loader=[{id:"bg",src:"bg.jpg?1"},{id:"btn_action",src:"btn_action.png"},{id:"btn_rule",src:"btn_rule.png"},{id:"num0",src:"num0.png"},{id:"num1",src:"num1.png"},{id:"num2",src:"num2.png"},{id:"num3",src:"num3.png"},{id:"h1",src:"h1.jpg"},{id:"h2",src:"h2.jpg"},{id:"err",src:"err.png"},{id:"btn_restart",src:"btn_restart.png"},{id:"btn_share",src:"btn_share.png"},{id:"btn_gift",src:"btn_gift.png"},{id:"step",src:"step.mp3"},{id:"die",src:"die.mp3"},{id:"suc",src:"suc.mp3"}],preload=new cj.LoadQueue(!1,"./img/");preload.installPlugin(cj.Sound),preload.loadManifest(loader),preload.on("fileload",loadProgress),preload.on("complete",loaded),col=4,col_w=W/col,col_h=col_w,col_w_2=col_w-1,col_h_2=col_h-1,step_max=100,border_color="#fff",current=1,total=0,TOTALSTEP=[],TIME=0,screenCount=Math.floor(H/col_h)+1,timeGo=null,gamed=!1,end=!1,$btn_action.on(click,checkReg),$btn_gift.on(click,function(){getMyGift(),$page.removeClass("current"),$page4.addClass("current")}),$btn_rank.on(click,function(){getRank(),$page.removeClass("current"),$page5.addClass("current")}),$(".gift .q_table tbody").on(click,".exchange",function(){if(ajaxLock)return!1;ajaxLock=!0;var a=$(this);load(),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"applyredpackage",wxid:active,id:a.attr("data-id"),activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",openid:openid},dataType:check.ajaxDataType,success:function(b){console.log(b),0==b.errorcode?(a.removeClass("exchange").addClass("t_gray").html("已兑换"),$log({title:"恭喜您领取了"+b.GrantCash+"元现金红包！"})):$tip(b.errormsg),load_h(),ajaxLock=!1},error:function(){load_h(),ajaxLock=!1,$tip(check.ajaxError)}})}),addShare($btn_share);