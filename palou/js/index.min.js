function gameOver(e){if(gamed=!0,clearInterval(timeGo),e)return setTimeout(function(){ns.numberTo($score,TIME.toFixed(2),.7,20),$info.html("胜败乃兵家常事，大侠请重新来过！"),$page.removeClass("current"),$page3.addClass("current")},1e3),cj.Sound.play("die",{loop:0}),!1;cj.Sound.play("suc",{loop:0}),ns.numberTo($score,TIME.toFixed(2),.7,20),$page.removeClass("current"),$page3.addClass("current")}function loadProgress(e){$progress.html((100*preload.progress).toFixed(2)+"%").width((100*preload.progress).toFixed(2)+"%")}function loaded(){$progress.parent().hide(),$(".btn_action").show()}function timeGoing(){TIME+=.05,$time.html(TIME.toFixed(2))}function create(e,a,t){var r=new cj.Shape;if(void 0!==t){if("right"==t)var o=preload.getResult("h1");else if("right_c"==t)var o=preload.getResult("h2");else var o=preload.getResult("err");r.graphics.s(border_color).bf(o).r(0,0,o.width,o.height),r.setTransform(e,a,col_w_2/o.width,col_h_2/o.height)}else r.graphics.s(border_color).f("rgba(255,255,255,.01)").r(e,a,col_w_2,col_h_2);return r}function createRow(e){e=e||1;for(var a=total;a<total+e;a++)for(var t,r,o=Math.floor(Math.random()*col),n=0;n<col;n++)o==n&&0!=a?(r=!0,t=create(n*col_w,H-(a+1)*col_h,"right")):(r=!1,t=create(n*col_w,H-(a+1)*col_h)),main.addChild(t),function(e,a,r){t.on("click",function(t){if(1==current&&(timeGo=setInterval(timeGoing,50)),e!=current||gamed)return!1;if(Math.random()<randomRedBag&&getRedBag(),r)cj.Sound.play("step",{loop:0}),current++,this.graphics=null,main.addChild(create(a*col_w,H-(e+1)*col_h,"right_c")),current>screenCount&&main.removeChildAt(0,1,2,3,4),current==total&&gameOver(),total<=step_max&&createRow(1),current<step_max-1&&(main.y+=col_h);else{this.graphics=null;var o=create(a*col_w,H-(e+1)*col_h,"err");main.addChild(o),cj.Tween.get(o).to({alpha:.5},400,cj.Ease.linear).to({alpha:.8},400,cj.Ease.linear).to({alpha:.5},400,cj.Ease.linear).loop=!0,gameOver(!0)}})}(a,n,r);total+=e}function init(){canvas.width=W,canvas.height=H,stage=new cj.Stage(canvas),main=new cj.Container,cj.Ticker.setFPS(60),cj.Touch.enable(stage),cj.Ticker.addEventListener("tick",stage),stage.addChild(main),createRow(screenCount+10)}function checkReg(){0==reged?$log({type:"reg",go:function(){var e=$("#name").val(),a=$("#tel").val();return!!check.name(e)&&(!!check.tel(a)&&(!ajaxLock&&(ajaxLock=!0,ns.load(),void $.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"reg",name:e,wxid:active,tel:a,openid:openid},dataType:check.ajaxDataType,success:function(t){console.log(t),0==t.errorcode?(myName=e,myTel=a,reged=1,$tip("注册成功！"),setTimeout(function(){location.href="index.html"},500)):$tip(t.errormsg),ns.loadHide(),ajaxLock=!1},error:function(){ns.loadHide(),ajaxLock=!1,$tip(check.ajaxError)}}))))}}):checkGame()}function checkGame(){ns.load(),$page.removeClass("current"),$page2.addClass("current"),setTimeout(function(){ns.loadHide(),init()},500)}function uploadScore(){ns.load(),console.log(TIME.toFixed(2),SnowCryEncrypt(TIME.toFixed(2),enKey,enIv)),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"recordscore",name:myName,wxid:active,activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",score:SnowCryEncrypt(TIME.toFixed(2),enKey,enIv),openid:openid},dataType:check.ajaxDataType,success:function(e){console.log(e),$tip("上传成绩成功！"),ns.loadHide()},error:function(){ns.loadHide(),$tip(check.ajaxError)}})}function getMyGift(){if(ajaxLock)return!1;ajaxLock=!0,ns.load(),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"getaward",wxid:active,activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",openid:openid},dataType:check.ajaxDataType,success:function(e){if(console.log(e),0==e.errorcode&&e.errormsg.length>0)for(var a=0,t=e.errormsg.length,r="",o="";a<t;a++)o="未兑奖"==e.errormsg[a].awardstate?'<a class="exchange" data-id="'+e.errormsg[a].awardid+'">领取</a>':'<a class="t_gray">'+e.errormsg[a].awardstate+"</a>",r+='<tr><td class="t_green">'+e.errormsg[a].awardname+" - "+e.errormsg[a].score+"元</td><td>"+o+"</td></tr>";else var r='<tr><td colspan="2">还没获得奖品呢！继续努力吧！</td></tr>';$(".gift .q_table tbody").html(r),ns.loadHide(),ajaxLock=!1},error:function(){ns.loadHide(),ajaxLock=!1,$tip(check.ajaxError)}})}function getRedBag(){ns.tip("获得红包！可惜是假的")}function getRank(){if(ajaxLock)return!1;ajaxLock=!0,ns.load(),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"getscorelist",wxid:active,activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",openid:openid},dataType:check.ajaxDataType,success:function(e){if(console.log(e.errormsg),0==e.errorcode){if(e.errormsg.length>0)for(var a=0,t=e.errormsg.length,r="";a<t;a++){var o="";bopenid==e.errormsg[a].openid&&(o=" isme"),r+='<tr class=" '+o+' "><td class="t_geo">'+(a+1)+"</td><td>"+e.errormsg[a].name+"</td><td>"+e.errormsg[a].score+"</td></tr>"}}else var r='<tr><td colspan="3">暂无排行数据！</td></tr>';$(".rank .q_table tbody").html(r),ajaxLock=!1,ns.loadHide()},error:function(){ajaxLock=!1,ns.loadHide(),$tip(check.ajaxError)}})}var W=$(window).width()>640?640:$(window).width(),H=$(window).height(),canvas=$("#canvas")[0],cj=createjs,$main=$("#main"),$game=$("#game"),$page=$(".page"),$page0=$(".page0"),$page1=$(".page1"),$page2=$(".page2"),$page3=$(".page3"),$page4=$(".page4"),$page5=$(".page5"),$score=$("#score"),$info=$("#info"),$time=$("#time"),$btn_action=$("#btn_action"),$btn_restart=$(".btn_restart"),$btn_share=$("#btn_share"),$btn_gift=$(".btn_gift"),$btn_rank=$(".btn_rank"),$progress=$(".progress span"),loader=[{id:"bg",src:"bg.jpg?1"},{id:"btn_action",src:"btn_action.png"},{id:"btn_rule",src:"btn_rule.png"},{id:"num0",src:"num0.png"},{id:"num1",src:"num1.png"},{id:"num2",src:"num2.png"},{id:"num3",src:"num3.png"},{id:"h1",src:"h1.jpg"},{id:"h2",src:"h2.jpg"},{id:"err",src:"err.png"},{id:"btn_restart",src:"btn_restart.png"},{id:"btn_share",src:"btn_share.png"},{id:"btn_gift",src:"btn_gift.png"},{id:"step",src:"step.mp3"},{id:"die",src:"die.mp3"},{id:"suc",src:"suc.mp3"}],preload=new cj.LoadQueue(!1,"./img/");preload.installPlugin(cj.Sound),preload.loadManifest(loader),preload.on("fileload",loadProgress),preload.on("complete",loaded);var col=4,col_w=W/col,col_h=col_w,col_w_2=col_w-1,col_h_2=col_h-1,step_max=100,border_color="#fff",current=1,total=0,TOTALSTEP=[],TIME=0,screenCount=Math.floor(H/col_h)+1;timeGo=null,gamed=!1,end=!1,$btn_action.on(click,checkReg),$btn_gift.on(click,function(){ns.tip("没有奖品！")}),$btn_rank.on(click,function(){ns.tip("暂无排行！")}),$(".gift .q_table tbody").on(click,".exchange",function(){if(ajaxLock)return!1;ajaxLock=!0;var e=$(this);ns.load(),$.ajax({type:check.ajaxType,url:check.ajaxUrl+"?xl="+Math.random().toFixed(3),data:{action:"applyredpackage",wxid:active,id:e.attr("data-id"),activetypeoid:"86c7778b-2f3f-4efe-b689-2edc040f37e3",openid:openid},dataType:check.ajaxDataType,success:function(a){console.log(a),0==a.errorcode?(e.removeClass("exchange").addClass("t_gray").html("已兑换"),$log({title:"恭喜您领取了"+a.GrantCash+"元现金红包！"})):$tip(a.errormsg),ns.loadHide(),ajaxLock=!1},error:function(){ns.loadHide(),ajaxLock=!1,$tip(check.ajaxError)}})}),ns.addShare($btn_share);var bgm=document.getElementById("bgmp3"),bgmPlayed=!1;$(document).on("touchstart",function(){bgmPlayed?bgm.play():!1!==bgm.paused&&(bgm.load(),bgmPlayed=!0,bgm.play()),$(document).unbind("touchstart")});