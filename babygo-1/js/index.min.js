!function(){function e(e){D.html((100*_.progress).toFixed(2)+"%").width((100*_.progress).toFixed(2)+"%")}function n(){D.parent().hide(),$(".btn_action").show(),t(),y.show(),ns.loadHide()}function a(){g.Tween.get(roadLr).to({y:0}).to({y:f},roadSpeed).call(function(){fallSpeed<roadSpeed&&(roadSpeed=fallSpeed),a()})}function t(){g.Touch.enable(S),S.clear(),main=new g.Container,S.addChild(main),TIME=0,timeGo=null,fallSpeed=5e3,roadSpeed=fallSpeed,waitTime=1500,COINS=[],Man_now=0,SCORE=0,TIME=0,lastDeviceGet=0,ACTION=!1}function o(){i(),clearInterval(timeGo),g.Ticker.setFPS(60),g.Ticker.addEventListener("tick",c),timeGo=setInterval(function(){TIME++},1e3)}function i(){w=_.getResult("roadLr").width*f/_.getResult("roadLr").height,u.width=w,u.height=f,roadLr=new g.Shape,roadLr.graphics.bf(_.getResult("roadLr"),"repeat-y",new g.Matrix2D(w/_.getResult("road").width,0,0,f/_.getResult("road").height,0,0)).dr(0,-f,w,2*f),road=new g.Bitmap(_.getResult("road")),road.setTransform(0,0,w/_.getResult("road").width,f/_.getResult("road").height),man_set={bw:125,bh:92,regX:0,regY:0,w:.18*w,x:.5*w,y:.87*f,count:10,speed:.07},man_set.h=man_set.bh*man_set.w/man_set.bw,man_set.hw=.5*man_set.w,man_set.hh=.5*man_set.h,man_set.bottom=man_set.y+man_set.hh,man_set.top=man_set.y-man_set.hh,coin_set={bw:130,bh:115,regX:0,regY:0,w:.13*w,h:.115*w,countC:5,probability:.3},coin_set.hw=.5*coin_set.w,coin_set.hh=.5*coin_set.h,coin_set.rowH=3.5*coin_set.h,coin_set.col=parseInt(f/coin_set.rowH)+1,S_LEFT=.15*w,S_RIGHT=.85*w,man_anim=new g.SpriteSheet({images:[_.getResult("man")],frames:{width:man_set.bw,height:man_set.bh,count:man_set.count,regX:man_set.regX,regY:man_set.regY},animations:{man0:{frames:[0],next:null}}}),man=new g.Sprite(man_anim,"man"+Man_now),man.setTransform(man_set.x,man_set.y,man_set.w/man_set.bw,man_set.h/man_set.bh,0,0,0,.5*man_set.bw,.5*man_set.bh).framerate=30,man.maxL=S_LEFT+man_set.hw,man.maxR=S_RIGHT-man_set.hw,man.trs=.5*w/90,coinsContainer=new g.Container,scoreBg=new g.Shape,scoreBg.graphics.f("#24981d").s("#fff").rr(.17*w,10,.66*w,.1*f,7),scoreShow=new g.Text("0 m","1rem georgiab","#fff"),scoreShow.x=.5*w,scoreShow.y=10+.05*f,scoreShow.textAlign="center",scoreShow.textBaseline="middle",main.addChild(roadLr,road,coinsContainer,scoreBg,scoreShow,man),window.DeviceMotionEvent?window.addEventListener("devicemotion",m,!1):$tip("亲，你的浏览器不支持重力感应哟~")}function s(e,n){SCORE>8e3?(fallSpeed=1500,waitTime=350):SCORE>6e3?(fallSpeed=2e3,waitTime=450):SCORE>5e3?(fallSpeed=2500,waitTime=600):SCORE>4e3?(fallSpeed=3e3,waitTime=700):SCORE>3e3?(fallSpeed=3500,waitTime=800):SCORE>2e3?(fallSpeed=4e3,waitTime=1e3):SCORE>1e3&&(fallSpeed=4500,waitTime=1200),COINS.length>15&&(COINS=COINS.splice(5,COINS.length));var a=r(Man_now),t=w*Math.random(),o=-coin_set.h;t<S_LEFT?t=S_LEFT:t>S_RIGHT-coin_set.w&&(t=S_RIGHT-coin_set.w),a.x=t,a.y=o,COINS.push(a),coinsContainer.addChild(a),g.Tween.get(a).to({y:f},fallSpeed),setTimeout(function(){s(e,!0)},waitTime)}function r(e){var n=Math.floor(Math.random()*coin_set.countC),a=new g.SpriteSheet({images:[_.getResult("coin")],frames:[[coin_set.bw*n,coin_set.bh*e,coin_set.bw,coin_set.bh]],animations:{go:{frames:[0],next:null}}}),t=new g.Sprite(a,"go");return t.setTransform(0,0,coin_set.w/coin_set.bw,coin_set.h/coin_set.bh).framerate=30,t}function c(){S.update(),ACTION&&(scoreShow.text=++SCORE+" m");for(var e=0,n=COINS.length;e<n;e++)if(COINS[e]&&!COINS[e].geted){if(!COINS[e].geted&&COINS[e].y-man_set.bottom>0)return void d();collCheck.rect(COINS[e],man)&&(COINS[e].geted=!0,g.Tween.removeTweens(COINS[e]),g.Tween.get(COINS[e]).to({x:.5*w,y:-coin_set.h,alpha:0},500,g.Ease.backIn))}}function m(e){var n=(new Date).getTime();if(n-lastDeviceGet>30){lastDeviceGet=n;var a=e.accelerationIncludingGravity,t=Math.round(a.x/9.81*-90);T&&(t*=-1);var o=man_set.x+t*man.trs;o<man.maxL&&(o=man.maxL),o>man.maxR&&(o=man.maxR),g.Tween.removeTweens(man),g.Tween.get(man).to({x:o},100,g.Ease.linear)}}function d(){SCORE>myBestScore?ns.numberTo(N,SCORE,37):N.html(myBestScore),g.Ticker.removeAllEventListeners(),clearInterval(timeGo),R.removeClass("current"),k.addClass("current"),ns.numberTo(L,SCORE,37)}function l(){load(),$.ajax({url:check.ajaxUrl+"?xl_r="+Math.random().toFixed(3),type:"POST",dataType:"json",data:{action:"queryList",pageIndex:x,pageSize:C,active:active},success:function(e){if(ns.loadHide(),console.log(e),0==e.errcode){ajaxLock=!1;var n=e.list,a=n.length,t="";if(a>0){x++;for(var o=0;o<a;o++)b++,t+='<li><span class="rank_num">'+b+'</span><span class="rank_name">'+n[o].name+'</span><span class="rank_score">'+(n[o].score||0)+"</span></li>";F.append(t)}else v=!0}}})}function h(){R.removeClass("current"),E.addClass("current"),o(),man.y=.2*f}var g=createjs,p=[{id:"bg",src:"bg.jpg"},{id:"t1",src:"t1.png"},{id:"btn_rule",src:"btn_rule.png"},{id:"btn_rank",src:"btn_rank.png"},{id:"btn_go",src:"btn_go.png"},{id:"rank",src:"rank.jpg"},{id:"btn_action",src:"btn_action.png"},{id:"road",src:"road.png"},{id:"roadLr",src:"roadLr.png"},{id:"man",src:"human.png"},{id:"coin",src:"coin.png"}],_=new g.LoadQueue(!1,"./img/");_.loadManifest(p),_.on("fileload",e),_.on("complete",n);var u=document.getElementById("canvas"),w=$(window).width()>320?320:$(window).width(),f=$(window).height(),S=new g.Stage(u),T=navigator.userAgent.match(/iP(ad|hone|od)/i),x=1,C=50,b=0,v=!1,y=($("#xl_loading_p"),$("#xl_loading"),$("#main")),I=$("#btn_go"),R=$(".page"),O=$(".page1"),E=$(".page2"),k=$(".page3"),L=($(".page4"),$("#distance")),N=$("#time"),M=$("#btn_action"),j=$(".phone"),G=$(".btn_rank"),H=$("#btn_restart"),B=$("#rank"),F=B.find("ul"),D=($("#myRank"),$("#myScore"),$(".progress span"));ns.load(),I.on(click,function(){if(1==reged)return void h();$log({title:"让你的朋友知道你吧！",conn:'<div class="tip">请输入您的昵称！</div><label class="in_ic40"><span class="l"><i class="fa fa-user"></i></span><span class="r"><input type="text" placeholder="请输入昵称" id="name" name="name" maxlength="12"/></span></label>',go:function(){var e=$("#name").val();if(!check.name(e))return!1;load(),$.ajax({url:check.ajaxUrl+"?xl_r="+Math.random().toFixed(3),type:check.ajaxType,data:{action:"reg",name:e,active:active,tel:"",openid:openid},dataType:check.ajaxDataType,success:function(n){0==n.errcode?(myName=e,myTel="",reged=1,$tip("注册成功！"),location.href="index.html"):$tip(n.errmsg),ns.loadHide()},error:function(){ns.loadHide(),$tip(check.ajaxError)}})}})}),M.on(click,function(){j.hide(),man.y=man_set.y,man.on("pressmove",function(e){e.stageX<man.maxL?man.x=man.maxL:e.stageX>man.maxR?man.x=man.maxR:man.x=e.stageX,e.stageY>man_set.y?man.y=man_set.y:e.stageY<man_set.hh+40?man.y=man_set.hh+40:man.y=e.stageY}),j.hide(),man.y=man_set.y,SCORE=0,ACTION=!0,setTimeout(function(){s("coins1")},1e3),a()}),G.on(click,function(){ns.tip("暂无排行！")}),H.on(click,function(){SCORE>0||TIME>0?location.href="index.html":(R.removeClass("current"),O.addClass("current"))}),B.scroll(function(){!v&&!ajaxLock&&F.height()-B.height()-B.scrollTop()<20&&(ajaxLock=!0,l())});var X=document.getElementById("bgmp3"),Y=!1;$(document).on("touchstart",function(){Y?X.play():!1!==X.paused&&(X.load(),Y=!0,X.play()),$(document).unbind("touchstart")})}();